(()=>{var E=class{constructor(){this.body=[],this.isProgram=!0}},T=class{constructor(e,s,t=null,n=null,r=!1){this.type=e,this.name=s,this.value=t,this.next=n,this.immutable=r,this.isVariableDeclaration=!0}},F=class{constructor(e,s){this.type=e,this.name=s,this.isUniform=!0}},w=class{constructor(e,s){this.type=e,this.name=s,this.isVarying=!0}},b=class{constructor(e,s,t=null,n=!0){this.type=e,this.name=s,this.qualifier=t,this.immutable=n,this.isFunctionParameter=!0}},R=class{constructor(e,s,t=[]){this.type=e,this.name=s,this.params=t,this.body=[],this.isFunctionDeclaration=!0}};var C=class{constructor(e,s,t){this.cond=e,this.left=s,this.right=t,this.isTernary=!0}},d=class{constructor(e,s,t){this.type=e,this.left=s,this.right=t,this.isOperator=!0}},k=class{constructor(e,s,t=!1){this.type=e,this.expression=s,this.after=t,this.isUnary=!0}},v=class{constructor(e,s="float"){this.type=s,this.value=e,this.isNumber=!0}},U=class{constructor(e){this.value=e,this.isString=!0}},x=class{constructor(e=null){this.cond=e,this.body=[],this.elseConditional=null,this.isConditional=!0}},D=class{constructor(e,s=[]){this.name=e,this.params=s,this.isFunctionCall=!0}},f=class{constructor(e){this.value=e,this.isReturn=!0}},O=class{constructor(){this.isDiscard=!0}},m=class{constructor(e){this.property=e,this.isAccessor=!0}},P=class{constructor(e){this.value=e,this.isStaticElement=!0}},A=class{constructor(e){this.value=e,this.isDynamicElement=!0}},y=class{constructor(e,s=[]){this.object=e,this.elements=s,this.isAccessorElements=!0}},I=class{constructor(e,s,t){this.initialization=e,this.condition=s,this.afterthought=t,this.body=[],this.isFor=!0}};var V=["+","-","~","!","++","--"],j=["*","/","%","-","+","<<",">>","<",">","<=",">=","==","!=","&","^","|","&&","^^","||","?","=","+=","-=","*=","/=","%=","^=","&=","|=","<<=",">>=",","].reverse(),H=["=","+=","-=","*=","/=","%=","^=","&=","|=","<<=",">>=",",","?",":"],Z={inversesqrt:"inverseSqrt"},J=["sampler1D","sampler2D","sampler2DArray","sampler2DShadow","sampler2DArrayShadow","isampler2D","isampler2DArray","usampler2D","usampler2DArray"],K=["samplerCube","samplerCubeShadow","usamplerCube","isamplerCube"],Q=["sampler3D","isampler3D","usampler3D"],W=/^((\t| )\n*)+/,X=/^\n+/,Y=/^\/\*[\s\S]*?\*\//,ee=/^\/\/.*?(\n|$)/,se=/^((0x\w+)|(\.?\d+\.?\d*((e-?\d+)|\w)?))/,te=/^(\"((?:[^"\\]|\\.)*)\")/,re=/^(\'((?:[^'\\]|\\.)*)\')/,ne=/^[A-Za-z](\w|\.)*/,ie=new RegExp("^(\\"+["<<=",">>=","++","--","<<",">>","+=","-=","*=","/=","%=","&=","^^","^=","|=","<=",">=","==","!=","&&","||","(",")","[","]","{","}",".",",",";","!","=","~","*","/","%","+","-","<",">","&","^","|","?",":","#"].join("$").split("").join("\\").replace(/\\\$/g,"|")+")");function oe(i){return Z[i]||i}function N(i){return i==="("||i==="["||i==="{"?1:i===")"||i==="]"||i==="}"?-1:0}var c=class i{constructor(e,s,t,n){this.tokenizer=e,this.type=s,this.str=t,this.pos=n,this.tag=null}get endPos(){return this.pos+this.str.length}get isNumber(){return this.type===i.NUMBER}get isString(){return this.type===i.STRING}get isLiteral(){return this.type===i.LITERAL}get isOperator(){return this.type===i.OPERATOR}};c.LINE="line";c.COMMENT="comment";c.NUMBER="number";c.STRING="string";c.LITERAL="literal";c.OPERATOR="operator";var M=[{type:c.LINE,regexp:X,isTag:!0},{type:c.COMMENT,regexp:Y,isTag:!0},{type:c.COMMENT,regexp:ee,isTag:!0},{type:c.NUMBER,regexp:se},{type:c.STRING,regexp:te,group:2},{type:c.STRING,regexp:re,group:2},{type:c.LITERAL,regexp:ne},{type:c.OPERATOR,regexp:ie}],S=class{constructor(e){this.source=e,this.position=0,this.tokens=[]}tokenize(){let e=this.readToken();for(;e;)this.tokens.push(e),e=this.readToken();return this}skip(...e){let s=this.source.substr(this.position),t=e.length;for(;t--;){let n=e[t].exec(s),r=n?n[0].length:0;r>0&&(this.position+=r,s=this.source.substr(this.position),t=e.length)}return s}readToken(){let e=this.skip(W);for(var s=0;s<M.length;s++){let t=M[s],n=t.regexp.exec(e);if(n){let r=new c(this,t.type,n[t.group||0],this.position);if(this.position+=n[0].length,t.isTag){let l=this.readToken();return l&&(l.tag=r),l}return r}}}},$=i=>/void|bool|float|u?int|mat[234]|mat[234]x[234]|(u|i|b)?vec[234]/.test(i),L=class{constructor(){this.index=0,this.tokenizer=null,this.keywords=[],this._currentFunction=null,this.addPolyfill("gl_FragCoord","vec3 gl_FragCoord = vec3( screenCoordinate.x, screenCoordinate.y.oneMinus(), screenCoordinate.z );")}addPolyfill(e,s){return this.keywords.push({name:e,polyfill:s}),this}get tokens(){return this.tokenizer.tokens}readToken(){return this.tokens[this.index++]}getToken(e=0){return this.tokens[this.index+e]}getTokensUntil(e,s,t=0){let n=[],r=0;for(let l=t;l<s.length;l++){let o=s[l];if(r+=N(o.str),n.push(o),r===0&&o.str===e)break}return n}readTokensUntil(e){let s=this.getTokensUntil(e,this.tokens,this.index);return this.index+=s.length,s}parseExpressionFromTokens(e){if(e.length===0)return null;let s=e[0],t=e[e.length-1],n=0;for(let r of j){let l=(o,a=!1)=>{let h=e[o];if(n+=N(h.str),!(!h.isOperator||o===0||o===e.length-1)){if(n===0&&h.str===r)if(r==="?"){let p=e.slice(0,o),u=this.getTokensUntil(":",e,o+1).slice(0,-1),g=e.slice(o+u.length+2),_=this.parseExpressionFromTokens(p),G=this.parseExpressionFromTokens(u),q=this.parseExpressionFromTokens(g);return new C(_,G,q)}else{let p=this.parseExpressionFromTokens(e.slice(0,o)),u=this.parseExpressionFromTokens(e.slice(o+1,e.length));return this._evalOperator(new d(r,p,u))}if(a){if(n>0)return this.parseExpressionFromTokens(e.slice(o))}else if(n<0)return this.parseExpressionFromTokens(e.slice(0,o))}};if(H.includes(r))for(let o=0;o<e.length;o++){let a=l(o);if(a)return a}else for(let o=e.length-1;o>=0;o--){let a=l(o,!0);if(a)return a}}if(s.isOperator){for(let r of V)if(s.str===r){let l=this.parseExpressionFromTokens(e.slice(1));return new k(r,l)}}if(t.isOperator){for(let r of V)if(t.str===r){let l=this.parseExpressionFromTokens(e.slice(0,e.length-1));return new k(r,l,!0)}}if(s.str==="("){let r=this.getTokensUntil(")",e),l=this.parseExpressionFromTokens(r.slice(1,r.length-1)),o=e[r.length];if(o){let a=e.slice(r.length+1),h=this.parseExpressionFromTokens(a);return this._evalOperator(new d(o.str,l,h))}return l}if(s.isNumber){let r,l=/^(0x)/.test(s.str);l?r="int":/u$|U$/.test(s.str)?r="uint":/f|e|\./.test(s.str)?r="float":r="int";let o=s.str.replace(/u|U|i$/,"");return l===!1&&(o=o.replace(/f$/,"")),new v(o,r)}else{if(s.isString)return new U(s.str);if(s.isLiteral){if(s.str==="return")return new f(this.parseExpressionFromTokens(e.slice(1)));if(s.str==="discard")return new O;let r=e[1];if(r){if(r.str==="("){let l=this.getTokensUntil(")",e,1).slice(1,-1),o=this.parseFunctionParametersFromTokens(l),a=new D(oe(s.str),o),h=e.slice(3+l.length);if(h.length>0){let p=this.parseAccessorElementsFromTokens(h);return new y(a,p)}return a}else if(r.str==="["){let l=this.parseAccessorElementsFromTokens(e.slice(1));return new y(new m(s.str),l)}}return new m(s.str)}}}parseAccessorElementsFromTokens(e){let s=[],t=e;for(;t.length>0;){let n=t[0];if(n.str==="["){let r=this.getTokensUntil("]",t),l=this.parseExpressionFromTokens(r.slice(1,r.length-1));t=t.slice(r.length),s.push(new A(l))}else if(n.str==="."){let r=t.slice(1,2),l=this.parseExpressionFromTokens(r);t=t.slice(2),s.push(new P(l))}else{console.error("Unknown accessor expression",n);break}}return s}parseFunctionParametersFromTokens(e){if(e.length===0)return[];let s=this.parseExpressionFromTokens(e),t=[],n=s;for(;n.type===",";)t.push(n.left),n=n.right;return t.push(n),t}parseExpression(){let e=this.readTokensUntil(";");return this.parseExpressionFromTokens(e.slice(0,e.length-1))}parseFunctionParams(e){let s=[];for(let t=0;t<e.length;t++){let n=e[t].str==="const";n&&t++;let r=e[t].str;/^(in|out|inout)$/.test(r)?t++:r=null;let l=e[t++].str,o=e[t++].str;if(s.push(new b(l,o,r,n)),e[t]&&e[t].str!==",")throw new Error('Expected ","')}return s}parseFunction(){let e=this.readToken().str,s=this.readToken().str,t=this.readTokensUntil(")"),n=this.parseFunctionParams(t.slice(1,t.length-1)),r=new R(e,s,n);return this._currentFunction=r,this.parseBlock(r),this._currentFunction=null,r}parseVariablesFromToken(e,s){let t=0,n=e[0].str==="const";n&&t++,s=s||e[t++].str;let r=e[t++].str,l=e[t],o=null,a=null;if(l){let p=this.getTokensUntil(",",e,t);if(p[0].str==="="){let g=p.slice(1);g[g.length-1].str===","&&g.pop(),o=this.parseExpressionFromTokens(g)}let u=e.slice(p.length+(t-1));u[0]&&u[0].str===","&&(a=this.parseVariablesFromToken(u.slice(1),s))}return new T(s,r,o,a,n)}parseVariables(){let e=this.readTokensUntil(";");return this.parseVariablesFromToken(e.slice(0,e.length-1))}parseUniform(){let e=this.readTokensUntil(";"),s=e[1].str,t=e[2].str;return J.includes(s)?s="texture":K.includes(s)?s="cubeTexture":Q.includes(s)&&(s="texture3D"),new F(s,t)}parseVarying(){let e=this.readTokensUntil(";"),s=e[1].str,t=e[2].str;return new w(s,t)}parseReturn(){this.readToken();let e=this.parseExpression();return new f(e)}parseFor(){this.readToken();let e=this.readTokensUntil(")").slice(1,-1),s=this.getTokensUntil(";",e,0).slice(0,-1),t=this.getTokensUntil(";",e,s.length+1).slice(0,-1),n=e.slice(s.length+t.length+2),r;s[0]&&$(s[0].str)?r=this.parseVariablesFromToken(s):r=this.parseExpressionFromTokens(s);let l=this.parseExpressionFromTokens(t),o=this.parseExpressionFromTokens(n),a=new I(r,l,o);return this.getToken().str==="{"?this.parseBlock(a):a.body.push(this.parseExpression()),a}parseIf(){let e=()=>{this.readToken();let r=this.readTokensUntil(")");return this.parseExpressionFromTokens(r.slice(1,r.length-1))},s=r=>{this.getToken().str==="{"?this.parseBlock(r):r.body.push(this.parseExpression())},t=new x(e());s(t);let n=t;for(;this.getToken()&&this.getToken().str==="else";){this.readToken();let r=n;this.getToken().str==="if"?n=new x(e()):n=new x,r.elseConditional=n,s(n)}return t}parseBlock(e){this.getToken().str==="{"&&this.readToken();let t=0;for(;this.index<this.tokens.length;){let n=this.getToken(),r=null;if(t+=N(n.str),t<0){this.readToken();break}n.isLiteral&&(n.str==="const"?r=this.parseVariables():n.str==="uniform"?r=this.parseUniform():n.str==="varying"?r=this.parseVarying():$(n.str)?this.getToken(2).str==="("?r=this.parseFunction():r=this.parseVariables():n.str==="return"?r=this.parseReturn():n.str==="if"?r=this.parseIf():n.str==="for"?r=this.parseFor():r=this.parseExpression()),r?e.body.push(r):this.index++}}_evalOperator(e){if(e.type.includes("=")){let s=this._getFunctionParameter(e.left.property);s!==void 0&&(s.immutable=!1)}return e}_getFunctionParameter(e){if(this._currentFunction){for(let s of this._currentFunction.params)if(s.name===e)return s}}parse(e){let s="";for(let n of this.keywords)new RegExp(`(^|\\b)${n.name}($|\\b)`,"gm").test(e)&&(s+=n.polyfill+`
`);s&&(s=`// Polyfills

`+s+`
`),this.index=0,this.tokenizer=new S(s+e).tokenize();let t=new E;return this.parseBlock(t),t}},B=L;var z=class extends B{constructor(){super(),this.addPolyfill("iTime","float iTime = time;"),this.addPolyfill("iResolution","vec2 iResolution = screenSize;"),this.addPolyfill("fragCoord","vec3 fragCoord = vec3( screenCoordinate.x, screenSize.y - screenCoordinate.y, screenCoordinate.z );")}parseFunction(){let e=super.parseFunction();if(e.name==="mainImage"){e.params=[],e.type="vec4",e.layout=!1;let s=new m("fragColor");for(let t of e.body)t.isReturn&&(t.value=s);e.body.unshift(new T("vec4","fragColor")),e.body.push(new f(s))}return e}},ue=z;})();
//# sourceMappingURL=ShaderToyDecoder.js.map
